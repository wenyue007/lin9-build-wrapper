#! /bin/bash -

kts()
{
    echo "Doing kts..."
    grep "wr-kts" conf/local.conf
    if [ $? -ne 0 ];then
        bitbake-layers add-layer /net/pek-lpgtest15/buildarea1/jhu2/wrl9-testing/wr-testing/kts-dev
        echo require templates/feature/wr-kts/template.conf >> conf/local.conf
        echo "BB_NO_NETWORK_pn-lmbench = '0'" >> conf/local.conf
        echo "Appended wr-kts into conf/local.conf"
    else
        echo "wr-kts already existed"
    fi
}

ltp()
{
    echo "Doing ltp..."
    grep "ltp" conf/local.conf
    if [ $? -ne 0 ];then
        bitbake-layers add-layer /net/pek-lpgtest15/buildarea1/jhu2/wrl9-testing/wr-testing/kts-dev
        echo require ./templates/feature/ltp/template.conf >> conf/local.conf
        echo "Appended ltp into conf/local.conf"
    else
        echo "lpt already existed"
    fi
}

bts()
{
    echo "Doing bts..."
    grep "bts" conf/local.conf
    if [ $? -ne 0 ];then
        bitbake-layers add-layer /net/pek-lpgtest15/buildarea1/jhu2/wrl9-testing/wr-testing/bts-dev
        echo require templates/feature/bts/template.conf >> conf/local.conf
        echo "Appended bts into conf/local.conf"
    else
        echo "bts already existed"
    fi
}

no_testing()
{
    echo "Clearing all testing layers..."
    sed "/templates\/feature\/wr-kts\/template.conf/d" conf/local.conf -i 
    sed "/templates\/feature\/bts\/template.conf/d" conf/local.conf -i
    sed "/templates\/feature\/ltp\/template.conf/d" conf/local.conf -i
    sed "/BB_NO_NETWORK_pn-lmbench/d" conf/local.conf -i
}

bsp_val=$1

if [ -z "$bsp_val" ];then
    echo yes | /net/pek-hostel-deb04.wrs.com/buildarea1/nightly/WRL9/product_install/wrlinux-9/setup.sh --list-machines
    echo "Need one machine name at latest!!!"
    exit 1
fi

#distros_val=$2
#if [ -z "$distros_val" ];then
#    /net/pek-hostel-deb04.wrs.com/buildarea1/nightly/WRL9/product_install/wrlinux-9/setup.sh --list-distros
#fi

kernel_val=$2
testing_type=
if [ "$kernel_val" = "bts" -o "$kernel_val" = "kts" -o "$kernel_val" = "ltp" ]; then
    testing_type=$kernel_val
    kernel_val="standard"
elif [ "$bsp_val" = "ultimate" ];then
    echo "Ultimate..."
    . ./environment-setup-x86_64-wrlinuxsdk-linux
    . ./oe-init-build-env build
    exit 0
else
    if [ -z "$kernel_val" ];then
        kernel_val="standard"
    elif [ "$kernel_val" = "std" ];then
        kernel_val="standard"
    elif [ "$kernel_val" = "rt" ];then
        kernel_val="preempt-rt"
    else
        echo "$kernel_val is wrong krenel type!!!"
        exit 1
    fi
fi

[ -z "$testing_type" ] && testing_type=$3
dog()
{
    echo $testing_type
    if [ "$testing_type" = "bts" ];then
        bts
    elif [ "$testing_type" = "kts" ];then
        kts
    elif [ "$testing_type" = "ltp" ];then
        ltp
    else
        echo "Not specified testing type,without any testing layers"
        no_testing
    fi
}

#main
if [ "$bsp_val" = "intel-skylake-avx512-64" ];then
    echo "/net/pek-hostel-deb04.wrs.com/buildarea1/nightly/WRL9/product_install/wrlinux-9/setup.sh --machines=$bsp_val --kernel=$kernel_val --distros=wrlinux-std-sato --base-url git://pek-git.wrs.com --dl-layers"
    eval "echo yes | /net/pek-hostel-deb04.wrs.com/buildarea1/nightly/WRL9/product_install/wrlinux-9/setup.sh --machines=$bsp_val --kernel=$kernel_val --distros=wrlinux-std-sato --base-url git://pek-git.wrs.com --dl-layers"
else
    echo "/net/pek-hostel-deb04.wrs.com/buildarea1/nightly/WRL9/product_install/wrlinux-9/setup.sh --machines=$bsp_val --kernel=$kernel_val --base-url git://pek-git.wrs.com --dl-layers"
    eval "echo yes | /net/pek-hostel-deb04.wrs.com/buildarea1/nightly/WRL9/product_install/wrlinux-9/setup.sh --machines=$bsp_val --kernel=$kernel_val --base-url git://pek-git.wrs.com --dl-layers"
fi
. ./environment-setup-x86_64-wrlinuxsdk-linux
. ./oe-init-build-env build

dog

#echo IMAGE_FSTYPES += \"tar.bz2\" >> conf/local.conf
echo "bitbake wrlinux-image-glibc-std"
bitbake wrlinux-image-glibc-std

